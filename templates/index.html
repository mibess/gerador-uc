<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de UC ANEEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }

        :root {
            --aneel-blue: #013F5C;
            --aneel-blue-light: #0A567A;
            --aneel-green: #7F8C2C;
        }

        /* Scroll estilizado */
        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: var(--aneel-blue) transparent;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: var(--aneel-blue);
            border-radius: 999px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background-color: var(--aneel-blue-light);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-100 via-slate-200 to-slate-100 flex items-center justify-center p-4">

    <div class="max-w-6xl w-full bg-white/70 backdrop-blur-xl rounded-[32px] shadow-2xl shadow-black/10 flex flex-col-reverse md:flex-row">

        <!-- FORM -->
        <div class="w-full px-8 sm:px-10 py-10 bg-gradient-to-b from-slate-50 via-white to-slate-100 rounded-b-[32px] md:rounded-none md:rounded-l-[32px]">

            <!-- HEADER -->
            <div class="mb-8">
                <div class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 mb-4">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full shadow"
                          style="background-color: var(--aneel-green); color:white;">
                        ⚡
                    </span>
                    <span class="text-xs font-medium text-slate-600 uppercase tracking-wide">
                        UC ANEEL
                    </span>
                </div>

                <h1 class="text-3xl font-semibold" style="color: var(--aneel-blue);">
                    Gerador de Código de UC
                </h1>
                <p class="text-sm text-slate-600">
                    Padrão ANEEL REN nº 1.095/2024
                </p>
            </div>

            <!-- FORM SELECT -->
            <form id="geradorForm" method="POST" action="/" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        Selecione a Distribuidora
                    </label>

                    <!-- DROPDOWN CUSTOM -->
                    <div id="distribuidoraDropdown" class="relative">

                        <!-- Botão -->
                        <button type="button"
                                id="distribuidoraButton"
                                class="w-full flex items-center justify-between rounded-full border border-slate-300 bg-white px-5 py-3 text-sm text-slate-900 shadow-sm hover:border-[var(--aneel-blue)] focus:outline-none focus:ring-2 focus:ring-[var(--aneel-blue-light)]">
                            <div id="distribuidoraLabel" class="flex justify-between w-full">
                                {% if distribuidora_selecionada %}
                                    {% for nome, codigo in distribuidoras %}
                                        {% if codigo == distribuidora_selecionada %}
                                            <span class="font-semibold">{{ nome }}</span>
                                            <span>{{ codigo.zfill(3) }}</span>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -- Escolha uma opção --
                                {% endif %}
                            </div>

                            <svg class="h-4 w-4 text-slate-400 ml-3"
                                 xmlns="http://www.w3.org/2000/svg" fill="none"
                                 viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>

                        <!-- Menu dropdown (cores ANEEL) -->
                        <div id="distribuidoraMenu"
                             class="absolute z-20 mt-2 w-full rounded-3xl bg-[var(--aneel-blue)] p-1 hidden">

                            <div class="max-h-64 overflow-y-auto rounded-3xl bg-white py-1 custom-scroll">

                                {% for nome, codigo in distribuidoras %}
                                <button type="button"
                                        class="flex justify-between w-full text-left px-4 py-2 text-sm transition
                                            {% if codigo == distribuidora_selecionada %}
                                                bg-[var(--aneel-blue)] text-white
                                            {% else %}
                                                text-slate-700 hover:bg-[var(--aneel-blue)] hover:text-white
                                            {% endif %}"
                                        data-value="{{ codigo }}">
                                    <span class="font-semibold">{{ nome }}</span>
                                    <span>{{ codigo.zfill(3) }}</span>
                                </button>
                                {% endfor %}

                            </div>
                        </div>

                        <!-- Hidden input -->
                        <input type="hidden" name="distribuidora"
                               id="distribuidoraInput"
                               value="{{ distribuidora_selecionada or '' }}">
                    </div>
                </div>

                <!-- BOTÃO AZUL ANEEL -->
                <button type="submit"
                        class="w-full rounded-full text-white font-semibold py-3 text-sm shadow-md transition-all duration-200"
                        style="background-color: var(--aneel-blue);"
                        onmouseover="this.style.backgroundColor='var(--aneel-blue-light)'"
                        onmouseout="this.style.backgroundColor='var(--aneel-blue)'">
                    Gerar novo código
                </button>

            </form>

            <!-- RESULTADO -->
            <div id="result-wrapper" class="{% if not numero_uc %}hidden{% endif %}">
                <div id="result-container"
                     class="mt-8 pt-6 border-t border-slate-300/70 transition-all duration-300 ease-out transform {% if numero_uc %}opacity-100 translate-y-0{% else %}opacity-0 translate-y-2{% endif %}">
                    <p class="text-xs font-medium text-slate-600 mb-3 text-center">
                        Novo Código de Unidade Consumidora (UC):
                    </p>

                    <div class="flex items-center justify-between rounded-2xl bg-slate-50 border border-slate-300 px-4 py-3 shadow-sm">
                        <span id="uc-gerada" class="text-lg font-mono font-semibold tracking-[0.2em] text-slate-900" aria-live="polite">
                            {{ numero_uc or '' }}
                        </span>

                        <button id="copyButton"
                                onclick="copiarUC()"
                                class="ml-3 rounded-full text-white px-3 py-2 text-xs font-medium transition"
                                style="background-color: var(--aneel-blue-light);">
                            Copiar
                        </button>
                    </div>

                    <p class="mt-3 text-[11px] text-center text-slate-500">
                        *O número sequencial (10 primeiros dígitos) é gerado aleatoriamente.
                    </p>
                </div>
            </div>


        </div>

        <!-- IMAGEM -->
        <div class="w-full md:w-7/12 relative h-80 md:h-auto rounded-t-[32px] md:rounded-none md:rounded-r-[32px] overflow-hidden">
            <img src="https://images.unsplash.com/photo-1517048676732-d65bc937f952?q=80&w=1740&auto=format&fit=crop"
                 alt="Equipe trabalhando" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-br from-black/10 via-black/5 to-black/20 pointer-events-none"></div>
        </div>

    </div>

<script>
function copiarUC() {
    const text = document.getElementById('uc-gerada')?.innerText;
    if (!text) return;

    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copyButton');
        btn.innerText = "Copiado!";
        btn.style.backgroundColor = "#2ECC71";

        setTimeout(() => {
            btn.innerText = "Copiar";
            btn.style.backgroundColor = "var(--aneel-blue-light)";
        }, 2000);
    });
}
</script>

<script>
(function () {
    const form = document.getElementById('geradorForm');
    const distribuidoraInput = document.getElementById('distribuidoraInput');
    const resultWrapper = document.getElementById('result-wrapper');
    const resultContainer = document.getElementById('result-container');
    const ucSpan = document.getElementById('uc-gerada');
    const triggerButton = document.getElementById('distribuidoraButton');

    if (!form || !window.fetch || !distribuidoraInput || !resultWrapper || !resultContainer || !ucSpan) {
        return;
    }

    const submitButton = form.querySelector('button[type="submit"]');
    if (!submitButton) return;

    const defaultButtonText = submitButton.innerText.trim();

    form.addEventListener('submit', async function (event) {
        event.preventDefault();

        if (!distribuidoraInput.value) {
            triggerButton?.focus();
            triggerButton?.classList.add('ring-2', 'ring-[var(--aneel-blue-light)]');
            setTimeout(function () {
                triggerButton?.classList.remove('ring-2', 'ring-[var(--aneel-blue-light)]');
            }, 400);
            return;
        }

        // o processo é muito rápido, então apenas um leve feedback visual
        //submitButton.disabled = true;
        //submitButton.innerText = 'Gerando...';
        submitButton.classList.add('opacity-70', 'cursor-not-allowed');

        try {
            const response = await fetch('/api/gerar-uc', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ distribuidora: distribuidoraInput.value })
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'Não foi possível gerar o código.');
            }

            ucSpan.innerText = data.numero_uc;
            resultWrapper.classList.remove('hidden');
            resultContainer.classList.remove('opacity-100', 'translate-y-0');
            resultContainer.classList.add('opacity-0', 'translate-y-2');
            resultContainer.getBoundingClientRect();
            resultContainer.classList.remove('opacity-0', 'translate-y-2');
            resultContainer.classList.add('opacity-100', 'translate-y-0');
            resultWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } catch (error) {
            console.error(error);
            alert(error.message || 'Erro ao gerar o código. Tente novamente.');
        } finally {
            submitButton.disabled = false;
            submitButton.innerText = defaultButtonText;
            submitButton.classList.remove('opacity-70', 'cursor-not-allowed');
        }
    });
})();
</script>

<script>
(function () {
    const dropdown   = document.getElementById('distribuidoraDropdown');
    const button     = document.getElementById('distribuidoraButton');
    const menu       = document.getElementById('distribuidoraMenu');
    const input      = document.getElementById('distribuidoraInput');
    const labelSpan  = document.getElementById('distribuidoraLabel');

    if (!dropdown || !button || !menu || !input || !labelSpan) return;

    button.addEventListener('click', function (e) {
        e.stopPropagation();
        menu.classList.toggle('hidden');
    });

    menu.querySelectorAll('button[data-value]').forEach(function (item) {
        item.addEventListener('click', function () {
            const value = this.getAttribute('data-value');

            input.value = value;
            // Copia exatamente o layout interno do botão selecionado
            labelSpan.innerHTML = this.innerHTML;

            menu.querySelectorAll('button[data-value]').forEach(function (btn) {
                btn.classList.remove('bg-[var(--aneel-blue)]', 'text-white');
                btn.classList.add('text-slate-700', 'hover:bg-[var(--aneel-blue)]', 'hover:text-white');
            });

            this.classList.add('bg-[var(--aneel-blue)]', 'text-white');
            this.classList.remove('text-slate-700', 'hover:bg-[var(--aneel-blue)]', 'hover:text-white');

            menu.classList.add('hidden');
        });
    });

    document.addEventListener('click', function (e) {
        if (!dropdown.contains(e.target)) {
            menu.classList.add('hidden');
        }
    });
})();
</script>

</body>
</html>
